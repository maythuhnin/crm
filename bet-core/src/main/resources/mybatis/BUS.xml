<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eniac.projects.bet.mappers.IBusMapper">

	<resultMap 			type="BusBean" 					id="BusResult">
		<id 			property="id" 					column="id" />
		<result 		property="licensePlate" 		column="license_plate" />
		<result		 	property="primaryDriverId" 		column="primary_driver_id" />
		<result 		property="secondaryDriverId" 	column="secondary_driver_id" />
		<result 		property="phone" 				column="phone" />
		<result 		property="status" 				column="status" />
		<result 		property="updatedId" 			column="updated_id" />
		<result 		property="updatedDateTime" 		column="updated_datetime" />
	</resultMap>

	<insert id="insertBus" parameterType="BusBean" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO bus(
			license_plate,
			primary_driver_id,
			secondary_driver_id,
			phone,
			status,
			updated_id,
			updated_datetime
			)
		VALUES(
			#{licensePlate},
			#{primaryDriverId},
			#{secondaryDriverId},
			#{phone},
			#{status},
			#{updatedId},
			NOW()
		)
	</insert>
	
	<update id="updateBus" parameterType="BusBean">
		UPDATE BUS SET 
			<if test="licensePlate != null">
				LICENSE_PLATE = #{licensePlate}
			</if>
			<if test="primaryDriverId != null">
				,PRIMARY_DRIVER_ID = #{primaryDriverId}
			</if>
			<if test="secondaryDriverId != null">
				,SECONDARY_DRIVER_ID = #{secondaryDriverId}
			</if>
			<if test="phone != null">
				,PHONE = #{phone}
			</if>
			<if test="status != null">
				,STATUS = #{status}
			</if>
			,updated_id = #{updatedId}
			,updated_datetime = NOW()
		WHERE ID =#{id} 
	</update>
	
	<update id="deleteBus" parameterType="int">
		UPDATE BUS SET STATUS = 2
		WHERE ID =#{id}
	</update>
	
	<select id="selectForDatatable" resultType="map">
		SELECT 
		 b.id,
		 b.license_plate AS licensePlate,
		 IFNULL(pd.name,"-") AS primaryDriver,
		 IFNULL(sd.name,"-") AS secondaryDriver,
		 IFNULL(b.phone,"-") AS phone,
		 b.status
		
		FROM bus b
		LEFT JOIN driver pd ON pd.id = b.primary_driver_id
		LEFT JOIN driver sd ON sd.id = b.secondary_driver_id
		WHERE b.status != 2
	</select>
	
	<select id="selectByCriteria" parameterType="map" resultMap="BusResult">
		SELECT * FROM bus 
			<where>
				<if test="license_plate != null">
					AND LICENSE_PLATE = #{license_plate}
				</if>
				<if test="notId != null">
					AND ID != #{notId}
				</if>
				AND STATUS != 2
			</where>
	</select>
	
	<select id="selectById" parameterType="int" resultMap="BusResult">
		SELECT * FROM bus WHERE id = #{id} AND status != 2
	</select>
	
</mapper>