<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eniac.projects.bet.mappers.IBusMapper">

	<resultMap 			type="BusBean" 					id="BusResult">
		<id 			property="id" 					column="id" />
		<result 		property="licensePlate" 		column="license_plate" />
		<result		 	property="primaryDriverId" 		column="primary_driver_id" />
		<result 		property="secondaryDriverId" 	column="secondary_driver_id" />
		<result 		property="status" 				column="status" />
		<result 		property="updatedId" 			column="updated_id" />
		<result 		property="updatedDateTime" 		column="updated_datetime" />
	</resultMap>

	<insert id="insertBus" parameterType="BusBean" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO bus(
			license_plate,
			primary_driver_id,
			secondary_driver_id,
			status,
			updated_id,
			updated_datetime
			)
		VALUES(
			#{licensePlate},
			#{primaryDriverId},
			#{secondaryDriverId},
			#{status},
			#{updatedId},
			NOW()
		)
	</insert>
	
	<update id="updateBus" parameterType="BusBean">
		UPDATE BUS SET 
			<if test="licensePlate != null">
				LICENSE_PLATE = #{licensePlate}
			</if>
			<if test="primaryDriverId != null">
				,PRIMARY_DRIVER_ID = #{primaryDriverId}
			</if>
			<if test="secondaryDriverId != null">
				,SECONDARY_DRIVER_ID = #{secondaryDriverId}
			</if>
			<if test="status != null">
				,STATUS = #{status}
			</if>
			,updated_id = #{updatedId}
			,updated_datetime = NOW()
		WHERE ID =#{id} 
	</update>
	
	<update id="deleteBus" parameterType="int">
		UPDATE BUS SET STATUS = 2
		WHERE ID =#{id}
	</update>
	
	<update id="removePrimaryDriver" parameterType="int">
		UPDATE BUS SET primary_driver_id = NULL WHERE primary_driver_id = #{id}
	</update>
	
	<update id="removeSecondaryDriver" parameterType="int">
		UPDATE BUS SET secondary_driver_id = NULL WHERE secondary_driver_id = #{id}
	</update>
	
	
	<select id="selectForDatatable" resultType="map">
		SELECT 
		 b.id,
		 b.license_plate AS licensePlate,
		 b.primary_driver_id AS primaryDriverId,
		 b.secondary_driver_id AS secondaryDriverId,
		 IFNULL(pd.name,"-") AS primaryDriver,
		 IFNULL(sd.name,"-") AS secondaryDriver,
		 IFNULL(pd.phone,"-") AS phone,
		 CASE b.status
		    WHEN 0 THEN "OK"
		    WHEN 1 THEN "REPAIRING"
		    ELSE "DELETED"
		 END AS status
		
		FROM bus b
		LEFT JOIN driver pd ON pd.id = b.primary_driver_id
		LEFT JOIN driver sd ON sd.id = b.secondary_driver_id
		WHERE b.status != 2
	</select>
	
	<select id="selectByCriteria" parameterType="map" resultMap="BusResult">
		SELECT * FROM BUS 
			<where>
				<if test="licensePlate != null">
					AND LICENSE_PLATE = #{licensePlate}
				</if>
				<if test="notId != null">
					AND ID != #{notId}
				</if>
				<if test="primaryDriverId != null">
					AND PRIMARY_DRIVER_ID = #{primaryDriverId}
				</if>
				<if test="secondaryDriverId != null">
					AND SECONDARY_DRIVER_ID = #{secondaryDriverId}
				</if>
				AND STATUS != 2
			</where>
	</select>
	
	<select id="selectById" parameterType="int" resultMap="BusResult">
		SELECT * FROM bus WHERE id = #{id} AND status != 2
	</select>
	
	<select id="selectForDropDown" resultMap="BusResult">
		SELECT 
		 id,
		 license_plate As licensePlate
		
		FROM bus
		WHERE status != 2
	</select>
	
</mapper>